<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loading Debug Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h2>Loading 状态调试工具</h2>
        
        <div class="alert alert-info">
            <strong>说明：</strong> 点击下面的按钮测试不同的API调用，观察"执行中"状态是否正确消失。
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">测试按钮</div>
                    <div class="card-body">
                        <button class="btn btn-primary mb-2" onclick="testGetTasks()">获取任务列表</button><br>
                        <button class="btn btn-success mb-2" onclick="testGetTaskFile()">获取任务文件</button><br>
                        <button class="btn btn-warning mb-2" onclick="testInvalidAPI()">测试错误API</button><br>
                        <button class="btn btn-danger mb-2" onclick="testSlowAPI()">测试慢速API</button><br>
                        <button class="btn btn-secondary mb-2" onclick="forceHideLoading()">强制关闭Loading</button>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">结果</div>
                    <div class="card-body">
                        <pre id="result" style="max-height: 300px; overflow-y: auto;"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 mb-1">执行中...</p>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="forceHideLoading()">
                        取消
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let loadingModal;

        function log(message) {
            const result = document.getElementById('result');
            const timestamp = new Date().toLocaleTimeString();
            result.textContent += `[${timestamp}] ${message}\n`;
            result.scrollTop = result.scrollHeight;
        }

        function showLoading() {
            if (!loadingModal) {
                loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
            }
            loadingModal.show();
            document.getElementById('loadingModal')._showTime = Date.now();
            log('Loading 显示');
        }

        function hideLoading() {
            if (loadingModal) {
                loadingModal.hide();
                log('Loading 隐藏');
            }
        }

        function forceHideLoading() {
            hideLoading();
            log('用户手动关闭 Loading');
        }

        async function makeRequest(url, data, method = 'GET') {
            showLoading();
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                if (method === 'POST') {
                    options.body = JSON.stringify(data);
                }
                
                const response = await fetch(url, options);
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('Request error:', error);
                return { success: false, error: '网络请求失败: ' + error.message };
            } finally {
                setTimeout(() => {
                    hideLoading();
                }, 100);
            }
        }

        async function testGetTasks() {
            log('开始测试：获取任务列表');
            const result = await makeRequest('http://localhost:8080/api/tasks');
            log('结果: ' + JSON.stringify(result, null, 2));
        }

        async function testGetTaskFile() {
            log('开始测试：获取任务文件');
            const result = await makeRequest('http://localhost:8080/api/tasks/file');
            log('结果: 文件内容长度 ' + (result.content ? result.content.length : 0) + ' 字符');
        }

        async function testInvalidAPI() {
            log('开始测试：无效API');
            const result = await makeRequest('http://localhost:8080/api/invalid');
            log('结果: ' + JSON.stringify(result, null, 2));
        }

        async function testSlowAPI() {
            log('开始测试：慢速API（模拟延迟）');
            showLoading();
            setTimeout(() => {
                hideLoading();
                log('慢速API测试完成');
            }, 3000);
        }

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            log('页面加载完成，开始初始化...');
            if (!loadingModal) {
                loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
            }
            log('初始化完成');
        });

        // 添加定时清理机制
        setInterval(function() {
            if (loadingModal && document.getElementById('loadingModal').classList.contains('show')) {
                const modal = document.getElementById('loadingModal');
                if (modal._showTime && Date.now() - modal._showTime > 30000) {
                    log('Loading 超时，自动关闭');
                    hideLoading();
                }
            }
        }, 5000);
    </script>
</body>
</html> 